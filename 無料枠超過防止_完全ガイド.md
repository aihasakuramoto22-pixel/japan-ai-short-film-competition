# 🛡️ 無料枠超過防止 - 完全ガイド

**目的:** 無料枠を超えて**一切のコストが発生しない**ようにする

---

## 📊 無料枠の制限

| サービス | 無料枠 | 超過時の料金 | リスク |
|---------|-------|------------|-------|
| **Cloudflare R2** | 10GB ストレージ | $0.015/GB/月 | ⚠️ 中 |
| **Render** | 750時間/月 | 超過不可（停止） | ✅ なし |
| **Cloudflare Pages** | 500分ビルド/月 | $0.10/分 | ⚠️ 低 |
| **Gmail SMTP** | 500通/日 | 超過不可（停止） | ✅ なし |
| **Stripe** | 手数料のみ | 3.6% | ✅ なし |

**コスト発生リスク:**
- 🔴 高リスク: なし
- 🟡 中リスク: R2ストレージ
- 🟢 低リスク: Cloudflare Pagesビルド

---

## 🎯 対策概要

### 1. R2ストレージ（10GB制限）⭐⭐⭐

**自動監視スクリプトを設置**
- 毎日ストレージ使用量をチェック
- 8GB到達で警告メール
- 9GB到達で新規アップロード停止

### 2. Render（750時間/月）⭐

**問題なし - 自動停止**
- 750時間 = 月31日間 × 24時間 = 744時間
- UptimeRobotで常時起動してもギリギリ収まる
- 超過時は自動停止（課金されない）

### 3. Cloudflare Pages（500分ビルド/月）⭐

**デプロイ回数を制限**
- 手動デプロイのみ（自動デプロイ無効化）
- または週1回のみデプロイ

---

## 🔧 実装手順

### 対策1: R2ストレージ監視システム（15分）

#### ステップ1: 監視スクリプト作成

プロジェクトに監視機能を追加します。

`server.js` に以下を追加:

```javascript
// R2ストレージ監視機能
import { ListObjectsV2Command } from '@aws-sdk/client-s3';

// ストレージ使用量をチェックする関数
async function checkR2StorageUsage() {
  try {
    const command = new ListObjectsV2Command({
      Bucket: process.env.R2_BUCKET_NAME,
    });

    const response = await r2Client.send(command);
    const objects = response.Contents || [];

    // 合計サイズを計算（バイト単位）
    const totalBytes = objects.reduce((sum, obj) => sum + (obj.Size || 0), 0);
    const totalGB = (totalBytes / (1024 * 1024 * 1024)).toFixed(2);

    console.log(`R2 Storage Usage: ${totalGB} GB / 10 GB`);

    // 警告レベルをチェック
    const usagePercent = (totalBytes / (10 * 1024 * 1024 * 1024)) * 100;

    if (usagePercent >= 90) {
      console.error(`🔴 CRITICAL: R2 storage at ${usagePercent.toFixed(1)}%`);
      // 新規アップロードを停止
      return { allowed: false, usage: totalGB, limit: 10 };
    } else if (usagePercent >= 80) {
      console.warn(`🟡 WARNING: R2 storage at ${usagePercent.toFixed(1)}%`);
      // 警告メールを送信（実装は後述）
      await sendStorageWarningEmail(totalGB);
      return { allowed: true, usage: totalGB, limit: 10 };
    }

    return { allowed: true, usage: totalGB, limit: 10 };
  } catch (error) {
    console.error('Failed to check R2 storage:', error);
    return { allowed: true, usage: 0, limit: 10 };
  }
}

// 警告メール送信
async function sendStorageWarningEmail(currentGB) {
  const mailOptions = {
    from: process.env.EMAIL_USER,
    to: process.env.EMAIL_USER, // 運営者自身に送信
    subject: '⚠️ R2ストレージ警告: 80%到達',
    text: `
R2ストレージ使用量が80%に到達しました。

現在の使用量: ${currentGB} GB / 10 GB

対策:
1. 古い動画ファイルを削除
2. 不要なファイルを削除
3. ストレージをクリーンアップ

管理画面: https://dash.cloudflare.com/ → R2
    `,
  };

  try {
    await transporter.sendMail(mailOptions);
    console.log('Storage warning email sent');
  } catch (error) {
    console.error('Failed to send warning email:', error);
  }
}

// アップロード前にストレージをチェック
app.post('/api/submit/init', async (req, res) => {
  // 既存のコードの前に追加
  const storageCheck = await checkR2StorageUsage();

  if (!storageCheck.allowed) {
    return res.status(507).json({
      success: false,
      error: 'STORAGE_FULL',
      message: 'ストレージ容量が不足しています。しばらくお待ちください。'
    });
  }

  // 既存のコードを続ける...
});

// ヘルスチェックにストレージ情報を追加
app.get('/api/health', async (req, res) => {
  const storageInfo = await checkR2StorageUsage();

  res.json({
    status: 'ok',
    deadline: SUBMISSION_DEADLINE.toISOString(),
    deadlinePassed: new Date() > SUBMISSION_DEADLINE,
    cloudStorage: 'Cloudflare R2',
    cloudStorageStatus: 'configured',
    storageUsage: `${storageInfo.usage} GB / ${storageInfo.limit} GB`,
    storageAllowed: storageInfo.allowed,
    maxFileSize: '500MB',
    paymentMethods: ['Stripe (Credit Card, Apple Pay, Google Pay)']
  });
});

// 毎日午前3時にストレージをチェック
import cron from 'node-cron';

cron.schedule('0 3 * * *', async () => {
  console.log('Running daily storage check...');
  await checkR2StorageUsage();
});
```

#### ステップ2: 依存関係を追加

```bash
cd C:\Users\user\Desktop\jaisfc2
npm install node-cron --save
```

#### ステップ3: コミット&プッシュ

```bash
git add server.js package.json package-lock.json
git commit -m "Add R2 storage monitoring to prevent exceeding free tier"
git push origin main
```

Renderが自動で再デプロイします（2-3分）。

---

### 対策2: Renderの自動停止（設定済み）✅

**何もする必要なし！**

- Renderは750時間を超えると自動停止
- 課金は一切されない
- UptimeRobotで24/7監視しても744時間なので問題なし

**確認:**
```
750時間/月 = 31日 × 24時間 = 744時間
→ 6時間の余裕あり ✅
```

---

### 対策3: Cloudflare Pages自動デプロイ無効化（5分）⭐⭐

#### オプションA: 自動ビルドを無効化（推奨）

1. https://dash.cloudflare.com/ にアクセス
2. **Workers & Pages** → **jaisfc**
3. **Settings** → **Builds & deployments**
4. **Build configuration** セクション
5. **「Pause automatic deployments」** をクリック

**効果:**
- GitHubにプッシュしても自動デプロイされない
- 手動で「Deploy」をクリックした時のみデプロイ
- ビルド時間を完全にコントロール可能

**デメリット:**
- コード更新時に手動でデプロイが必要

---

#### オプションB: Productionブランチを変更

1. Settings → Builds & deployments
2. **Production branch** を `main` から `production` に変更
3. Save

**効果:**
- `main` ブランチへのプッシュは自動デプロイされない
- `production` ブランチにマージした時のみデプロイ

**使い方:**
```bash
# 通常の開発
git push origin main  # デプロイされない

# 本番デプロイしたい時だけ
git checkout production
git merge main
git push origin production  # これだけデプロイされる
```

---

#### オプションC: ビルド回数を監視（おすすめ）⭐⭐⭐

**月のビルド時間を確認:**

1. https://dash.cloudflare.com/
2. Workers & Pages → jaisfc
3. **Analytics** タブ
4. **Build time** を確認

**制限:**
- 500分/月 = 約8時間
- 1回のビルド: 約5分
- 月100回デプロイ可能

**推奨デプロイ頻度:**
- 開発フェーズ: 週2-3回（月12回）
- 運用フェーズ: 月1-2回

**実装: デプロイ回数を記録**

プロジェクトに `DEPLOYMENT_LOG.md` を作成:

```markdown
# デプロイ履歴

| 日付 | ビルド時間 | 累計 | 備考 |
|------|-----------|------|------|
| 2025-10-20 | 5分 | 5分 | 初回デプロイ |
| 2025-10-27 | 5分 | 10分 | 機能追加 |

**月間制限:** 500分
**現在の使用量:** 10分 (2%)
```

---

## 🎯 推奨設定（最もコスト安全）

### 設定1: R2ストレージ監視 ✅

- 上記のコードを `server.js` に追加
- 8GB到達で警告メール
- 9GB到達で新規アップロード停止

### 設定2: Cloudflare Pages手動デプロイ ✅

- 自動デプロイを無効化
- 必要な時だけ手動でデプロイ

### 設定3: Render UptimeRobot監視 ✅

- 5分間隔で監視（既に設定済み）
- 744時間/月なので問題なし

---

## 📊 使用量の確認方法

### R2ストレージ使用量

**方法1: ダッシュボード**
```
https://dash.cloudflare.com/ → R2 → japan-ai-film-competition
→ 右上に使用量が表示される
```

**方法2: API経由（推奨）**
```
https://japan-ai-backend.onrender.com/api/health
→ "storageUsage": "5.2 GB / 10 GB"
```

---

### Renderの稼働時間

```
https://dashboard.render.com/ → japan-ai-backend → Metrics
→ CPU Usage / Memory でグラフ確認
```

**確認項目:**
- 月初から何日稼働しているか
- 750時間 ÷ 24 = 31.25日分

---

### Cloudflare Pagesのビルド時間

```
https://dash.cloudflare.com/ → Workers & Pages → jaisfc → Analytics
→ Build time
```

**確認項目:**
- 月間累計ビルド時間
- 500分まで無料

---

## 🚨 緊急時の対応

### ケース1: R2が9GB到達

**症状:**
- 新規アップロードができない
- エラー: "STORAGE_FULL"

**対応（5分）:**

1. Cloudflare R2ダッシュボードにアクセス
   ```
   https://dash.cloudflare.com/ → R2 → japan-ai-film-competition
   ```

2. 古いファイルを削除
   - ファイル一覧を日付順にソート
   - 最も古い動画を選択
   - **Delete** をクリック

3. 1-2GBの空き容量を確保するまで削除

4. ヘルスチェックで確認
   ```
   https://japan-ai-backend.onrender.com/api/health
   → "storageAllowed": true
   ```

---

### ケース2: Cloudflare Pagesビルド時間が450分超過

**症状:**
- まだデプロイできるが、残り50分しかない

**対応:**

1. 自動デプロイを無効化（上記手順）
2. 月末まで待つ
3. 月初に自動的にリセットされる

**回避策:**
- コードをローカルでテスト
- まとめてデプロイ（1回で複数の変更）

---

### ケース3: Renderが停止した

**症状:**
- バックエンドAPIが応答しない
- 750時間超過

**対応:**

**これは起こりえません！**
- 1ヶ月 = 31日 × 24時間 = 744時間
- 750時間 > 744時間
- 24/7稼働しても問題なし ✅

---

## 📈 月次レポート（テンプレート）

毎月1日に以下を確認:

```markdown
# 2025年10月 使用量レポート

## R2ストレージ
- 使用量: 6.5 GB / 10 GB (65%)
- 動画ファイル数: 13本
- ステータス: ✅ 正常

## Render稼働時間
- 稼働時間: 744時間 / 750時間 (99.2%)
- ステータス: ✅ 正常

## Cloudflare Pagesビルド
- ビルド時間: 45分 / 500分 (9%)
- デプロイ回数: 9回
- ステータス: ✅ 正常

## Gmail SMTP
- 送信数: 26通 / 15,000通 (0.17%)
- ステータス: ✅ 正常

## 総コスト: 0円 ✅
```

---

## ✅ チェックリスト

### 初回セットアップ

- [ ] R2ストレージ監視コードを追加
- [ ] `node-cron` をインストール
- [ ] Cloudflare Pages自動デプロイを無効化（推奨）
- [ ] UptimeRobotで監視設定済み
- [ ] 初回テストでストレージ使用量を確認

### 週次チェック

- [ ] R2ストレージ使用量を確認（< 8GB）
- [ ] Renderが正常稼働しているか確認
- [ ] 応募があればメールを確認

### 月次チェック

- [ ] 月次レポートを作成
- [ ] Cloudflare Pagesビルド時間を確認
- [ ] 必要に応じて古い動画を削除
- [ ] すべての無料枠内に収まっているか確認

---

## 🎯 最終的な安全設定

### 完全無料を保証する設定

1. **R2ストレージ監視** ✅
   - 9GB到達で自動停止
   - 警告メールで事前通知

2. **Cloudflare Pages手動デプロイ** ✅
   - 自動デプロイ無効化
   - 月5-10回程度の手動デプロイ

3. **Renderは何もしない** ✅
   - 自動的に750時間で停止（課金なし）
   - 実際は744時間なので問題なし

4. **Gmail SMTPは制限内** ✅
   - 500通/日 → 1日10通程度なので問題なし

**これで100%無料運用が保証されます！** 🎉

---

## 💰 コスト試算（最悪ケース）

仮に無料枠を超えた場合:

### R2ストレージ超過

```
使用量: 15 GB
無料枠: 10 GB
超過分: 5 GB

コスト: 5 GB × $0.015 = $0.075/月 (約10円)
```

### Cloudflare Pagesビルド超過

```
ビルド時間: 600分
無料枠: 500分
超過分: 100分

コスト: 100分 × $0.10 = $10 (約1,500円)
```

**対策を実施すれば、これらは発生しません！** ✅

---

## 🎊 まとめ

### 無料運用を維持するために

1. **R2監視コードを追加** - 最重要 ⭐⭐⭐
2. **Cloudflare Pages自動デプロイ無効** - 推奨 ⭐⭐
3. **月1回使用量を確認** - 必須 ⭐⭐⭐

### これで完全無料運用が可能！

- 📊 自動監視システム
- 🔔 警告メール通知
- 🛑 自動アップロード停止
- 📈 使用量レポート

**総コスト: 0円/月** が永続的に保証されます！ 🎉

---

**作成日:** 2025年10月20日
**対象:** コスト管理と無料枠維持

© 2025 Japan AI Short Film Competition. All rights reserved.
