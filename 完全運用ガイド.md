# 🎬 Japan AI Short Film Competition - 完全運用ガイド

**プロジェクト名:** JAPAN AI SHORT FILM COMPETITION
**本番URL:** https://jaisfc.pages.dev
**バックエンドAPI:** https://japan-ai-backend.onrender.com
**総運用コスト:** **0円/月** (永久無料)

---

## 📑 目次

1. [システム構成](#システム構成)
2. [本番環境URL](#本番環境url)
3. [完全無料デプロイ手順](#完全無料デプロイ手順)
4. [環境変数一覧](#環境変数一覧)
5. [日常運用](#日常運用)
6. [応募者管理](#応募者管理)
7. [トラブルシューティング](#トラブルシューティング)
8. [セキュリティ](#セキュリティ)
9. [監視とメンテナンス](#監視とメンテナンス)
10. [コスト管理](#コスト管理)

---

## 🏗️ システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー                              │
│                   (世界中からアクセス)                        │
└───────────────┬─────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────┐
│          Cloudflare Pages (フロントエンド)                 │
│          https://jaisfc.pages.dev                         │
│          - React + Vite                                   │
│          - Cloudflare CDN (全世界200拠点)                  │
│          - 無制限トラフィック                               │
│          - 自動SSL/HTTPS                                  │
│          - コスト: 0円                                     │
└───────────────┬───────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────┐
│          Render Web Service (バックエンド)                 │
│          https://japan-ai-backend.onrender.com            │
│          - Node.js + Express                              │
│          - Stripe決済処理                                  │
│          - メール送信                                       │
│          - 月100GB転送                                     │
│          - コスト: 0円                                     │
└───────────────┬───────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────┐
│          Cloudflare R2 (動画ストレージ)                    │
│          - S3互換ストレージ                                 │
│          - 10GB無料ストレージ                               │
│          - 無制限ダウンロード帯域                            │
│          - コスト: 0円                                     │
└───────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────┐
│          Stripe (決済処理)                                 │
│          - クレジットカード                                 │
│          - Apple Pay / Google Pay                         │
│          - 手数料: 3.6% (売上から差し引き)                  │
│          - コスト: 0円                                     │
└───────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────┐
│          Gmail SMTP (メール送信)                           │
│          - japanaishortfilmcompetition@gmail.com          │
│          - 1日500通まで無料                                 │
│          - コスト: 0円                                     │
└───────────────────────────────────────────────────────────┘
```

**総コスト: 0円/月** ✅

---

## 🌐 本番環境URL

| サービス | URL | 用途 |
|---------|-----|------|
| **メインサイト** | https://jaisfc.pages.dev | 一般ユーザーアクセス |
| **バックエンドAPI** | https://japan-ai-backend.onrender.com/api | API通信 |
| **ヘルスチェック** | https://japan-ai-backend.onrender.com/api/health | システム状態確認 |
| **Cloudflare R2** | `japan-ai-film-competition` バケット | 動画保存 |
| **Stripe決済** | https://dashboard.stripe.com | 決済管理 |
| **Gmail** | japanaishortfilmcompetition@gmail.com | 通知メール |

---

## 🚀 完全無料デプロイ手順

### ステップ1: フロントエンド (Cloudflare Pages)

**所要時間:** 15分
**詳細手順:** `CLOUDFLARE_PAGES_SETUP.md` 参照

1. https://dash.cloudflare.com/ にアクセス
2. Workers & Pages → Create application → Pages
3. GitHubリポジトリ接続: `japan-ai-short-film-competition`
4. ビルド設定:
   ```
   Project name: jaisfc
   Build command: npm run build
   Build output directory: dist
   Framework preset: Vite
   ```
5. 環境変数を追加:
   ```
   VITE_API_URL=https://japan-ai-backend.onrender.com/api
   VITE_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_STRIPE_PUBLISHABLE_KEY
   ```
6. Save and Deploy

**結果:** https://jaisfc.pages.dev が稼働 ✅

---

### ステップ2: バックエンド (Render)

**所要時間:** 10分
**詳細手順:** `RENDER_BACKEND_ENV_SETUP.md` 参照

1. https://dashboard.render.com/ にアクセス
2. New Web Service
3. GitHubリポジトリ接続: `japan-ai-short-film-competition`
4. 設定:
   ```
   Name: japan-ai-backend
   Build Command: npm install
   Start Command: node server.js
   Instance Type: Free
   ```
5. 環境変数を追加 (後述の環境変数一覧参照)
6. Create Web Service

**結果:** https://japan-ai-backend.onrender.com が稼働 ✅

---

### ステップ3: 動画ストレージ (Cloudflare R2)

**所要時間:** 10分
**詳細手順:** `CLOUDFLARE_R2_SETUP.md` 参照

1. Cloudflareダッシュボード → R2
2. バケット作成: `japan-ai-film-competition`
3. APIトークン発行
4. Renderの環境変数に追加

**結果:** 動画アップロード機能が稼働 ✅

---

### ステップ4: 決済 (Stripe)

**所要時間:** 5分

1. https://dashboard.stripe.com/ にログイン
2. テストモード → APIキー取得
3. Webhook設定:
   ```
   URL: https://japan-ai-backend.onrender.com/api/webhook
   Events: payment_intent.succeeded, payment_intent.payment_failed
   ```

**結果:** クレジットカード決済が稼働 ✅

---

## 🔐 環境変数一覧

### Cloudflare Pages (フロントエンド)

| 変数名 | 値 | 説明 |
|--------|---|------|
| `VITE_API_URL` | `https://japan-ai-backend.onrender.com/api` | バックエンドAPI |
| `VITE_STRIPE_PUBLISHABLE_KEY` | `pk_test_51SJQj3...` | Stripe公開鍵 |

---

### Render (バックエンド)

| 変数名 | 値 | 説明 |
|--------|---|------|
| **基本設定** |||
| `NODE_ENV` | `production` | 本番環境モード |
| `PORT` | `3001` | サーバーポート |
| `FRONTEND_URL` | `https://jaisfc.pages.dev` | CORS許可URL |
| **Cloudflare R2** |||
| `R2_ENDPOINT` | `https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com` | R2エンドポイント |
| `R2_ACCESS_KEY_ID` | `YOUR_R2_ACCESS_KEY_ID` | アクセスキー |
| `R2_SECRET_ACCESS_KEY` | `YOUR_R2_SECRET_ACCESS_KEY` | シークレットキー |
| `R2_BUCKET_NAME` | `japan-ai-film-competition` | バケット名 |
| **Stripe決済** |||
| `STRIPE_SECRET_KEY` | `sk_test_YOUR_STRIPE_SECRET_KEY` | Stripeシークレット |
| **メール送信** |||
| `EMAIL_USER` | `japanaishortfilmcompetition@gmail.com` | 送信元メール |
| `EMAIL_PASSWORD` | `YOUR_GMAIL_APP_PASSWORD` | アプリパスワード |

---

## 📅 日常運用

### 1. コードの更新とデプロイ

```bash
cd C:\Users\user\Desktop\jaisfc2

# 変更を確認
git status

# 変更をコミット
git add .
git commit -m "変更内容を記述"

# GitHubにプッシュ
git push origin main
```

**自動デプロイ:**
- Cloudflare Pages: 約3分で自動デプロイ
- Render: 約2分で自動デプロイ

---

### 2. サイトの動作確認

毎日1回は以下を確認:

**フロントエンド確認:**
```
https://jaisfc.pages.dev
```
✅ サイトが表示される
✅ 言語切り替えが動作
✅ 応募フォームが表示される

**バックエンド確認:**
```
https://japan-ai-backend.onrender.com/api/health
```

**期待される出力:**
```json
{
  "status": "ok",
  "deadline": "2025-11-30T23:59:59.000Z",
  "deadlinePassed": false,
  "cloudStorage": "Cloudflare R2",
  "cloudStorageStatus": "configured"
}
```

---

### 3. Renderのスリープ対策

Renderの無料プランは15分間アクセスがないとスリープします。

**解決策:** UptimeRobotで定期監視

詳細手順: `RENDER_FREE_PLAN_KEEPALIVE.md` 参照

1. https://uptimerobot.com/ (無料アカウント作成)
2. Monitor追加:
   ```
   Monitor Type: HTTP(s)
   URL: https://japan-ai-backend.onrender.com/api/health
   Monitoring Interval: 5分
   ```
3. 完了

**結果:** サイトが常時稼働状態に ✅

---

## 👥 応募者管理

### 応募完了時の通知

応募者がフォーム送信すると以下が自動送信されます:

1. **応募者へ確認メール**
   - 送信元: `japanaishortfilmcompetition@gmail.com`
   - 件名: 「【Japan AI Short Film Competition】応募を受け付けました」
   - 内容: 応募内容の確認

2. **運営者へ通知メール**
   - 宛先: `japanaishortfilmcompetition@gmail.com`
   - 件名: 「【新規応募】Japan AI Short Film Competition」
   - 内容: 応募者情報、動画URL

### 応募データの確認

**方法1: Gmailで確認**
- `japanaishortfilmcompetition@gmail.com` の受信トレイ
- 件名「【新規応募】」でフィルタ

**方法2: Cloudflare R2で動画確認**
1. https://dash.cloudflare.com/ → R2
2. バケット `japan-ai-film-competition` を開く
3. アップロードされた動画ファイルを確認

**方法3: Stripeで決済確認**
1. https://dashboard.stripe.com/
2. Payments → すべての決済を確認
3. 顧客情報、金額、日時を確認

---

## 🔧 トラブルシューティング

### 問題1: サイトが表示されない

**確認項目:**
```bash
# Cloudflare Pagesの状態確認
https://dash.cloudflare.com/ → Workers & Pages → jaisfc → Deployments
```

**解決策:**
- 最新デプロイが「Success」か確認
- 失敗している場合は「Retry deployment」

---

### 問題2: APIエラー (CORS)

**症状:**
```
Access to XMLHttpRequest blocked by CORS policy
```

**原因:** Renderの `FRONTEND_URL` が間違っている

**解決策:**
1. https://dashboard.render.com/
2. `japan-ai-backend` → Environment
3. `FRONTEND_URL` を確認:
   ```
   FRONTEND_URL=https://jaisfc.pages.dev
   ```
4. 修正して保存 → 自動再デプロイ

---

### 問題3: 動画アップロードエラー

**症状:**
```
Failed to upload video
```

**原因:** R2の環境変数が設定されていない

**解決策:**
1. Render → `japan-ai-backend` → Environment
2. R2関連変数を確認:
   ```
   R2_ENDPOINT=https://...
   R2_ACCESS_KEY_ID=...
   R2_SECRET_ACCESS_KEY=...
   R2_BUCKET_NAME=japan-ai-film-competition
   ```
3. 正しい値を設定して保存

---

### 問題4: メールが届かない

**確認項目:**
1. Gmailアプリパスワードが有効か
2. スパムフォルダに入っていないか
3. サーバーログを確認

**解決策:**
1. Render → `japan-ai-backend` → Logs
2. エラーメッセージを確認
3. `EMAIL_USER`, `EMAIL_PASSWORD` を再設定

---

### 問題5: Renderがスリープする

**症状:** 初回アクセスが遅い (30秒以上)

**解決策:**
UptimeRobotで定期監視 (`RENDER_FREE_PLAN_KEEPALIVE.md` 参照)

---

## 🛡️ セキュリティ

### 1. 環境変数の管理

⚠️ **絶対に公開してはいけない情報:**
- `STRIPE_SECRET_KEY`
- `R2_SECRET_ACCESS_KEY`
- `EMAIL_PASSWORD`

✅ **安全な管理方法:**
- Cloudflare Pages/Renderの環境変数機能を使用
- GitHubにコミットしない (`.env` は `.gitignore` に追加済み)

---

### 2. 実装済みセキュリティ機能

✅ **レート制限**
- 同一IPから1分間に10リクエストまで
- 超過すると429エラー

✅ **ファイルサイズ制限**
- 動画: 最大500MB
- 画像: 最大5MB

✅ **ファイル形式検証**
- 動画: `.mp4`, `.mov`, `.avi`, `.mkv`
- 画像: `.jpg`, `.jpeg`, `.png`

✅ **CORS保護**
- `https://jaisfc.pages.dev` からのみアクセス許可

✅ **SQLインジェクション対策**
- `express-mongo-sanitize` 使用

✅ **XSS対策**
- `helmet` ミドルウェア使用

---

### 3. Stripe決済セキュリティ

✅ **PCI DSS準拠**
- カード情報は直接サーバーに送信されない
- Stripe.jsで暗号化

✅ **Webhook署名検証**
- 不正なWebhookリクエストを拒否

---

## 📊 監視とメンテナンス

### 日次チェックリスト

- [ ] フロントエンドが正常に表示される (`https://jaisfc.pages.dev`)
- [ ] バックエンドAPIが応答する (`/api/health`)
- [ ] メールが正常に送信される
- [ ] 新規応募がある場合、メールを確認

### 週次チェックリスト

- [ ] Cloudflare Pages デプロイ履歴確認
- [ ] Render ログ確認 (エラーがないか)
- [ ] Stripe 決済履歴確認
- [ ] R2 ストレージ使用量確認

### 月次チェックリスト

- [ ] npm依存関係のアップデート (`npm audit`)
- [ ] セキュリティパッチ適用
- [ ] バックアップ確認 (R2動画、応募データ)

---

## 💰 コスト管理

### 無料枠の制限

| サービス | 無料枠 | 現在の使用量目安 | 超過時の対応 |
|---------|-------|----------------|------------|
| **Cloudflare Pages** | 月500分ビルド時間 | 約50分 (月10回デプロイ) | ビルド回数を減らす |
| **Render** | 月750時間稼働 | 720時間 (24/7稼働) | 問題なし |
| **Cloudflare R2** | 10GBストレージ | 約5GB (50本の動画) | 古い動画を削除 |
| **Gmail SMTP** | 1日500通 | 1日10通程度 | 問題なし |
| **Stripe** | 手数料のみ | 売上の3.6% | 売上から差し引き |

**総コスト: 0円/月** ✅

---

### コスト発生のリスク

⚠️ **注意が必要なケース:**

1. **R2ストレージが10GB超過**
   - 超過分: $0.015/GB/月
   - 対策: 古い動画を削除

2. **Renderの月750時間超過**
   - 超過不可 (自動停止)
   - 対策: 有料プラン ($7/月) または別サービス併用

3. **Cloudflare Pagesのビルド時間超過**
   - 超過分: $0.10/分
   - 対策: デプロイ頻度を減らす

**通常の運用では無料枠で十分です！**

---

## 📚 関連ドキュメント

| ファイル名 | 内容 |
|-----------|------|
| `CLOUDFLARE_PAGES_SETUP.md` | フロントエンドデプロイ詳細 |
| `RENDER_BACKEND_ENV_SETUP.md` | バックエンド環境変数設定 |
| `CLOUDFLARE_R2_SETUP.md` | 動画ストレージ設定 |
| `RENDER_FREE_PLAN_KEEPALIVE.md` | スリープ対策 |
| `CLOUDFLARE_DNS_SETUP.md` | カスタムドメイン設定 |
| `README.md` | プロジェクト概要 |

---

## 🎯 応募締切管理

### 締切日時の変更

現在の締切: **2025年11月30日 23:59**

**変更方法:**

1. `server.js` を編集:
```javascript
// 応募締切の設定
const SUBMISSION_DEADLINE = new Date('2025-11-30T23:59:59+09:00');
```

2. コミット&プッシュ:
```bash
git add server.js
git commit -m "Update submission deadline"
git push origin main
```

3. Renderが自動再デプロイ (2-3分)

---

### 締切後の処理

締切を過ぎると:
- 応募フォームが自動的に非表示
- APIが応募を拒否
- `/api/health` が `deadlinePassed: true` を返す

**手動で締切を延長する場合:**
上記の手順で `SUBMISSION_DEADLINE` を更新

---

## 🔗 クイックリンク集

### 管理画面

- [Cloudflare ダッシュボード](https://dash.cloudflare.com/)
- [Render ダッシュボード](https://dashboard.render.com/)
- [Stripe ダッシュボード](https://dashboard.stripe.com/)
- [Gmail (応募管理)](https://mail.google.com/)

### 本番環境

- [メインサイト](https://jaisfc.pages.dev)
- [バックエンドAPI](https://japan-ai-backend.onrender.com/api/health)

### GitHub

- [リポジトリ](https://github.com/aihasakuramoto22-pixel/japan-ai-short-film-competition)

---

## 📞 緊急時の対応

### サイトが完全にダウンした場合

1. **Cloudflare Pagesの状態確認**
   ```
   https://www.cloudflarestatus.com/
   ```

2. **Renderの状態確認**
   ```
   https://status.render.com/
   ```

3. **ロールバック (前のバージョンに戻す)**
   ```bash
   cd C:\Users\user\Desktop\jaisfc2
   git log  # 戻したいコミットのハッシュを確認
   git revert <コミットハッシュ>
   git push origin main
   ```

4. **手動でデプロイをやり直す**
   - Cloudflare Pages: Deployments → Retry deployment
   - Render: Manual Deploy → Deploy latest commit

---

## ✅ 運用チェックリスト

### 初回セットアップ完了確認

- [ ] Cloudflare Pagesが稼働 (`https://jaisfc.pages.dev`)
- [ ] Renderバックエンドが稼働 (`/api/health` が200応答)
- [ ] Cloudflare R2バケット作成済み
- [ ] Stripe Webhook設定済み
- [ ] Gmail SMTP設定済み
- [ ] UptimeRobot監視設定済み
- [ ] すべての環境変数が正しく設定されている

### 応募開始前確認

- [ ] テスト応募が正常に動作する
- [ ] 決済テストが成功する
- [ ] 動画アップロードが成功する
- [ ] 確認メールが届く
- [ ] 運営者通知メールが届く
- [ ] 締切日時が正しい

### 応募期間中の定期確認

- [ ] 毎日1回サイトにアクセスして動作確認
- [ ] 応募通知メールを確認
- [ ] Renderログでエラーがないか確認
- [ ] R2ストレージ使用量を週1回確認

---

## 🎉 まとめ

**あなたが今手にしているもの:**

✅ プロフェッショナルな動画応募サイト
✅ Stripe決済統合
✅ 世界中から高速アクセス可能
✅ 自動SSL/HTTPS対応
✅ 完全無料で運営可能
✅ スケーラブルなインフラ

**総運用コスト: 0円/月**

**サポートが必要な場合:**
- 各種ドキュメント参照
- GitHub Issues
- Cloudflare/Render/Stripeの公式ドキュメント

---

**作成日:** 2025年10月20日
**最終更新:** デプロイ成功後
**対象:** コンテスト運営者

---

© 2025 Japan AI Short Film Competition. All rights reserved.
