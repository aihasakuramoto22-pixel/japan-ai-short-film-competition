# 🔧 ファイルアップロード「Network Error」修正ガイド

## ❌ エラー内容

本番環境 (`https://jaisfc.pages.dev`) でファイルをアップロードすると **「Network Error」** が表示される。

---

## 🎯 原因と解決策

### 原因1: バックエンドがスリープしている（最も可能性が高い）⭐

Renderの無料プランは **15分間アクセスがないとスリープ**します。

#### 確認方法

ブラウザで以下にアクセス:
```
https://japan-ai-backend.onrender.com/api/health
```

**症状:**
- 30秒以上待つ → スリープしている
- すぐに応答 → スリープしていない

#### 即座の解決策（一時的）

1. 上記URLにアクセスしてバックエンドを起動
2. 応答が返ってきたら、サイトでもう一度アップロードを試す

#### 恒久的な解決策: UptimeRobot設定（5分）

**UptimeRobotで5分ごとに監視:**

##### ステップ1: アカウント作成

1. https://uptimerobot.com/ にアクセス
2. **「Sign Up」** をクリック
3. メールアドレスでアカウント作成（無料）
4. メール確認

##### ステップ2: Monitor作成

1. ダッシュボード → **「+ Add New Monitor」** をクリック
2. 以下を設定:

```
Monitor Type: HTTP(s)
Friendly Name: JAISFC Backend
URL (or IP): https://japan-ai-backend.onrender.com/api/health
Monitoring Interval: 5 minutes
```

3. **「Create Monitor」** をクリック

##### ステップ3: 確認

- Statusが **「Up」** になることを確認
- これで5分ごとにアクセスされ、スリープしなくなります ✅

---

### 原因2: Cloudflare Pagesの環境変数が間違っている

#### 確認方法

1. https://dash.cloudflare.com/ にアクセス
2. **Workers & Pages** → **jaisfc** プロジェクトをクリック
3. **Settings** → **Environment variables**

#### 正しい設定

```
VITE_API_URL=https://japan-ai-backend.onrender.com/api
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_STRIPE_PUBLISHABLE_KEY
```

**重要:**
- `VITE_API_URL` の末尾に `/api` が含まれているか確認
- 間違い: `https://japan-ai-backend.onrender.com`
- 正しい: `https://japan-ai-backend.onrender.com/api`

#### 修正後の手順

1. 環境変数を修正
2. **Save** をクリック
3. **Deployments** タブに移動
4. 最新デプロイの **「⋯」** → **「Retry deployment」**
5. 3-5分待ってデプロイ完了

---

### 原因3: RenderのFRONTEND_URLが間違っている

CORS（Cross-Origin Resource Sharing）エラーの可能性があります。

#### 確認方法

1. https://dashboard.render.com/ にアクセス
2. **japan-ai-backend** サービスをクリック
3. **Environment** タブ

#### 正しい設定

```
FRONTEND_URL=https://jaisfc.pages.dev
```

**重要:**
- 末尾にスラッシュ `/` を付けない
- `https://` を必ず付ける

#### 修正後

1. 環境変数を修正
2. **Save Changes** をクリック
3. 自動で再デプロイされる（2-3分）
4. **Logs** タブでエラーがないか確認

---

### 原因4: ファイルサイズが大きすぎる

#### 制限

- **動画**: 最大 500MB
- **画像**: 最大 5MB

#### 確認方法

アップロードしようとしているファイルのサイズを確認:
- Windows: ファイルを右クリック → プロパティ
- Mac: ファイルを右クリック → 情報を見る

#### 解決策

ファイルサイズが制限を超えている場合:
1. 動画編集ソフトで圧縮
2. 解像度を下げる（推奨: 1080p以下）
3. ビットレートを下げる

---

### 原因5: タイムアウト（大きいファイルの場合）

大きいファイル（300MB以上）をアップロードする場合、タイムアウトする可能性があります。

#### 解決策: タイムアウト設定を延長

`server.js` を修正:

```javascript
// タイムアウトを10分に延長
app.use((req, res, next) => {
  req.setTimeout(600000); // 10 minutes
  res.setTimeout(600000);
  next();
});
```

この修正を加えた後:
```bash
cd C:\Users\user\Desktop\jaisfc2
git add server.js
git commit -m "Increase upload timeout to 10 minutes"
git push origin main
```

Renderが自動で再デプロイします（2-3分）。

---

## 🔍 デバッグ方法

### 1. ブラウザの開発者ツールで確認

#### ステップ1: 開発者ツールを開く

1. サイト `https://jaisfc.pages.dev` にアクセス
2. **F12キー** を押す（または右クリック → 検証）

#### ステップ2: Consoleタブを確認

エラーメッセージを確認:
```
Network Error
Failed to load resource: net::ERR_CONNECTION_TIMED_OUT
CORS policy error
```

#### ステップ3: Networkタブを確認

1. **Network** タブをクリック
2. ファイルをアップロード
3. 失敗したリクエストを見つける（赤色）
4. クリックして詳細を確認

**確認項目:**
- Request URL が正しいか
- Status Code が何か（404, 500, timeout など）
- Response に何か表示されるか

---

### 2. バックエンドログを確認

#### Renderでログを確認

1. https://dashboard.render.com/ にアクセス
2. **japan-ai-backend** サービスをクリック
3. **Logs** タブ

**確認項目:**
- エラーメッセージがないか
- `POST /api/upload` のログがあるか
- タイムアウトエラーがないか

---

### 3. APIを直接テスト

#### curlでテスト（Windows PowerShell）

```powershell
# ヘルスチェック
curl https://japan-ai-backend.onrender.com/api/health

# 期待される出力
# {"status":"ok","cloudStorage":"Cloudflare R2",...}
```

#### ブラウザでテスト

```
https://japan-ai-backend.onrender.com/api/health
```

正常に表示されればバックエンドは動作しています。

---

## ✅ 完全チェックリスト

### バックエンド確認

- [ ] バックエンドが起動している (`/api/health` にアクセスして確認)
- [ ] UptimeRobotで監視設定済み（スリープ対策）
- [ ] Renderの環境変数が正しい:
  - [ ] `FRONTEND_URL=https://jaisfc.pages.dev`
  - [ ] `R2_ENDPOINT` が設定されている
  - [ ] `R2_ACCESS_KEY_ID` が設定されている
  - [ ] `R2_SECRET_ACCESS_KEY` が設定されている
  - [ ] `R2_BUCKET_NAME=japan-ai-film-competition`

### フロントエンド確認

- [ ] Cloudflare Pagesの環境変数が正しい:
  - [ ] `VITE_API_URL=https://japan-ai-backend.onrender.com/api`
  - [ ] `VITE_STRIPE_PUBLISHABLE_KEY` が設定されている
- [ ] 最新のコードがデプロイされている

### ファイル確認

- [ ] 動画ファイルが500MB以下
- [ ] ファイル形式が対応している（.mp4, .mov, .avi, .mkv）

### ネットワーク確認

- [ ] インターネット接続が安定している
- [ ] ファイアウォールやVPNが干渉していない

---

## 🚀 推奨フロー

### 問題が起きたら、この順番で確認:

1. **バックエンドを起動**
   ```
   https://japan-ai-backend.onrender.com/api/health
   ```
   → 30秒以上待つ場合はスリープしていた → UptimeRobotを設定

2. **環境変数を確認**
   - Cloudflare Pages: `VITE_API_URL`
   - Render: `FRONTEND_URL`

3. **ブラウザの開発者ツールでエラー確認**
   - F12 → Console → エラーメッセージ
   - Network → 失敗したリクエスト

4. **小さいファイルでテスト**
   - 10MB以下の動画でテスト
   - 成功すれば、ファイルサイズの問題

5. **Renderログを確認**
   - エラーメッセージがあればそれを解決

---

## 📊 エラーパターン別対処法

### パターンA: すぐに「Network Error」

**原因:** バックエンドがスリープまたは環境変数間違い

**解決策:**
1. バックエンドを起動（上記URL）
2. 環境変数確認
3. UptimeRobot設定

---

### パターンB: アップロード中に「Network Error」

**原因:** タイムアウトまたはファイルサイズ

**解決策:**
1. ファイルサイズを確認
2. タイムアウト設定を延長（上記参照）
3. 小さいファイルでテスト

---

### パターンC: 「CORS Error」

**原因:** `FRONTEND_URL` が間違っている

**解決策:**
1. Renderの環境変数 `FRONTEND_URL` を確認
2. `https://jaisfc.pages.dev` に修正
3. 再デプロイ

---

### パターンD: 「Failed to upload to R2」

**原因:** R2の環境変数が間違っている

**解決策:**
1. Renderの環境変数を確認:
   - `R2_ENDPOINT`
   - `R2_ACCESS_KEY_ID`
   - `R2_SECRET_ACCESS_KEY`
   - `R2_BUCKET_NAME`
2. Cloudflare R2でバケットが存在するか確認
3. APIトークンの権限を確認

---

## 🎯 最も効果的な解決策（今すぐ実行）

### 1. UptimeRobotでバックエンドを常時起動 ⭐⭐⭐

https://uptimerobot.com/ で5分間隔の監視を設定

### 2. 環境変数を再確認 ⭐⭐

- Cloudflare Pages: `VITE_API_URL`
- Render: `FRONTEND_URL`, R2関連

### 3. バックエンドを手動起動 ⭐

https://japan-ai-backend.onrender.com/api/health にアクセス

---

## 📞 それでも解決しない場合

### 詳細情報を収集

1. ブラウザの開発者ツール（F12）のスクリーンショット
2. Renderのログのスクリーンショット
3. アップロードしようとしているファイルのサイズ
4. 使用しているブラウザとOS

### 一時的な回避策

- 小さいファイル（50MB以下）でテスト
- 別のブラウザで試す
- シークレットモードで試す

---

## 🎉 解決後の確認

すべて修正したら、以下を確認:

1. **本番サイトでテスト:**
   ```
   https://jaisfc.pages.dev
   ```
   - 10MB程度のテスト動画でアップロード
   - 決済まで完了するか確認

2. **メールが届くか確認:**
   - 応募者への確認メール
   - 運営者への通知メール

3. **R2にアップロードされたか確認:**
   - Cloudflare R2ダッシュボード
   - バケット内にファイルが表示される

---

**作成日:** 2025年10月20日
**最終更新:** デプロイ後

© 2025 Japan AI Short Film Competition. All rights reserved.
