# ğŸ›¡ï¸ R2å®¹é‡è‡ªå‹•åœæ­¢æ©Ÿèƒ½ - å®Ÿè£…ã‚³ãƒ¼ãƒ‰

**ç›®çš„:** R2ãŒ9GBåˆ°é”ã§è‡ªå‹•çš„ã«å¿œå‹Ÿå—ä»˜ã‚’åœæ­¢

---

## ğŸ“‹ å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

### 1. è‡ªå‹•åœæ­¢ï¼ˆ9GBåˆ°é”æ™‚ï¼‰
- R2ä½¿ç”¨é‡ã‚’è‡ªå‹•ãƒã‚§ãƒƒã‚¯
- 9GBï¼ˆ90%ï¼‰åˆ°é”ã§æ–°è¦å¿œå‹Ÿã‚’è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

### 2. è­¦å‘Šé€šçŸ¥ï¼ˆ8GBåˆ°é”æ™‚ï¼‰
- 8GBï¼ˆ80%ï¼‰åˆ°é”ã§é‹å–¶è€…ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- äº‹å‰ã«å¯¾å¿œå¯èƒ½

### 3. æ‰‹å‹•ç·Šæ€¥åœæ­¢
- ç’°å¢ƒå¤‰æ•°ã§å³åº§ã«åœæ­¢
- ç·Šæ€¥æ™‚ç”¨

---

## ğŸ”§ å®Ÿè£…æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: server.jsã«é–¢æ•°ã‚’è¿½åŠ 

`server.js` ã® **`function isDeadlinePassed()`** ã®å¾Œã«ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ :

```javascript
// Emergency stop flag (can be set via environment variable)
function isEmergencyStopped() {
  return process.env.EMERGENCY_STOP === 'true';
}

// R2 Storage monitoring
async function checkR2StorageUsage() {
  try {
    const bucketName = process.env.R2_BUCKET_NAME || 'japan-ai-film-competition';
    const command = new ListObjectsV2Command({
      Bucket: bucketName,
    });

    const response = await r2Client.send(command);
    const objects = response.Contents || [];

    // Calculate total size in bytes
    const totalBytes = objects.reduce((sum, obj) => sum + (obj.Size || 0), 0);
    const totalGB = (totalBytes / (1024 * 1024 * 1024)).toFixed(2);
    const usagePercent = (totalBytes / (10 * 1024 * 1024 * 1024)) * 100;

    console.log(`R2 Storage Usage: ${totalGB} GB / 10 GB (${usagePercent.toFixed(1)}%)`);

    // Check if storage is near limit
    if (usagePercent >= 90) {
      console.error(`ğŸ”´ CRITICAL: R2 storage at ${usagePercent.toFixed(1)}% - Blocking new submissions`);
      return { allowed: false, usage: totalGB, limit: 10, usagePercent: usagePercent.toFixed(1) };
    } else if (usagePercent >= 80) {
      console.warn(`ğŸŸ¡ WARNING: R2 storage at ${usagePercent.toFixed(1)}%`);
      // Send warning email (implement below)
      await sendStorageWarningEmail(totalGB, usagePercent.toFixed(1));
    }

    return { allowed: true, usage: totalGB, limit: 10, usagePercent: usagePercent.toFixed(1) };
  } catch (error) {
    console.error('Failed to check R2 storage:', error);
    // Allow submissions if check fails (fail open)
    return { allowed: true, usage: 0, limit: 10, usagePercent: 0 };
  }
}

// Send storage warning email
async function sendStorageWarningEmail(currentGB, usagePercent) {
  const mailOptions = {
    from: process.env.EMAIL_USER,
    to: process.env.EMAIL_USER,
    subject: 'âš ï¸ R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è­¦å‘Š: 80%åˆ°é”',
    text: `
R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒ80%ã«åˆ°é”ã—ã¾ã—ãŸã€‚

ç¾åœ¨ã®ä½¿ç”¨é‡: ${currentGB} GB / 10 GB (${usagePercent}%)

å¯¾ç­–:
1. å¤ã„å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
2. ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
3. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

90%åˆ°é”æ™‚ã€æ–°è¦å¿œå‹Ÿã‚’è‡ªå‹•åœæ­¢ã—ã¾ã™ã€‚

ç®¡ç†ç”»é¢: https://dash.cloudflare.com/ â†’ R2 â†’ japan-ai-film-competition

ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚
Japan AI Short Film Competition é‹å–¶ã‚·ã‚¹ãƒ†ãƒ 
    `,
  };

  try {
    await transporter.sendMail(mailOptions);
    console.log('Storage warning email sent');
  } catch (error) {
    console.error('Failed to send warning email:', error);
  }
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—2: `/api/submit/init` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä¿®æ­£

`server.js` ã® `/api/submit/init` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆç´„170è¡Œç›®ä»˜è¿‘ï¼‰ã‚’æ¢ã—ã¦ã€**æœ€åˆã«**ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ :

```javascript
app.post('/api/submit/init',
  strictLimiter,
  [
    body('name').trim().notEmpty().isLength({ max: 100 }),
    body('email').isEmail().normalizeEmail(),
    body('filmTitle').trim().notEmpty().isLength({ max: 200 }),
    body('fileSize').isNumeric().custom(value => value <= 500 * 1024 * 1024),
    body('fileName').trim().notEmpty()
  ],
  async (req, res) => {
    // === ã“ã“ã‹ã‚‰è¿½åŠ  ===

    // Check if emergency stopped
    if (isEmergencyStopped()) {
      return res.status(503).json({
        success: false,
        error: 'SERVICE_UNAVAILABLE',
        message: 'ç¾åœ¨ã€å¿œå‹Ÿå—ä»˜ã‚’ä¸€æ™‚åœæ­¢ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
      });
    }

    // Check R2 storage capacity
    const storageCheck = await checkR2StorageUsage();
    if (!storageCheck.allowed) {
      return res.status(507).json({
        success: false,
        error: 'STORAGE_FULL',
        message: 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚é‹å–¶ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚'
      });
    }

    // === ã“ã“ã¾ã§è¿½åŠ  ===

    // Check deadline
    if (isDeadlinePassed()) {
      return res.status(400).json({
        success: false,
        error: 'DEADLINE_PASSED',
        message: 'The submission deadline has passed.'
      });
    }

    // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶šã‘ã‚‹...
```

---

### ã‚¹ãƒ†ãƒƒãƒ—3: `/api/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æƒ…å ±è¿½åŠ 

`/api/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆç´„468è¡Œç›®ä»˜è¿‘ï¼‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›´æ–°:

```javascript
app.get('/api/health', async (req, res) => {
  const r2Configured = !!(process.env.R2_ENDPOINT && process.env.R2_ACCESS_KEY_ID && process.env.R2_SECRET_ACCESS_KEY && process.env.R2_BUCKET_NAME);

  // Check storage status
  let storageInfo = { usage: 'unknown', usagePercent: 0, allowed: true };
  if (r2Configured) {
    storageInfo = await checkR2StorageUsage();
  }

  res.json({
    status: 'ok',
    deadline: DEADLINE.toISOString(),
    deadlinePassed: isDeadlinePassed(),
    emergencyStopped: isEmergencyStopped(),
    cloudStorage: 'Cloudflare R2',
    cloudStorageStatus: r2Configured ? 'configured' : 'not configured',
    storageUsage: `${storageInfo.usage} GB / ${storageInfo.limit} GB`,
    storagePercent: `${storageInfo.usagePercent}%`,
    submissionsAllowed: !isDeadlinePassed() && !isEmergencyStopped() && storageInfo.allowed,
    maxFileSize: '500MB',
    paymentMethods: ['Stripe (Credit Card, Apple Pay, Google Pay)']
  });
});
```

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†

`src/components/AIFilmCompetition.jsx` ã® `handleSubmit` é–¢æ•°ã§ã€æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†:

ç´„250-270è¡Œç›®ä»˜è¿‘ã® `try-catch` ãƒ–ãƒ­ãƒƒã‚¯ã® `catch` éƒ¨åˆ†ã‚’ç¢ºèª:

```javascript
} catch (error) {
  console.error('Submission error:', error);
  setUploadStage('error');
  setIsSubmitting(false);

  // === ã“ã®éƒ¨åˆ†ã‚’è¿½åŠ /æ›´æ–° ===
  if (error.response?.data?.error === 'STORAGE_FULL') {
    setErrorMessage(lang === 'ja'
      ? 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€ç¾åœ¨å¿œå‹Ÿã‚’å—ã‘ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚é‹å–¶ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚'
      : 'Storage capacity is full. Please contact the organizers.');
  } else if (error.response?.data?.error === 'SERVICE_UNAVAILABLE') {
    setErrorMessage(lang === 'ja'
      ? 'ç¾åœ¨ã€å¿œå‹Ÿå—ä»˜ã‚’ä¸€æ™‚åœæ­¢ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
      : 'Submissions are temporarily unavailable. Please try again later.');
  } else if (error.response?.data?.error === 'RATE_LIMIT') {
    setErrorMessage(t.rateLimitError);
  } else {
    setErrorMessage(t.uploadError);
  }
  // === ã“ã“ã¾ã§ ===

  setShowError(true);
}
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 1. ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ

```bash
cd C:\Users\user\Desktop\jaisfc2

# å¤‰æ›´ã‚’ç¢ºèª
git status

# ã‚³ãƒŸãƒƒãƒˆ
git add server.js src/components/AIFilmCompetition.jsx
git commit -m "Add automatic R2 storage monitoring and emergency stop

- Block submissions when R2 storage reaches 90% (9GB)
- Send warning email at 80% (8GB)
- Add manual emergency stop via environment variable
- Update health endpoint with storage info
- Add frontend error handling for storage errors"

# ãƒ—ãƒƒã‚·ãƒ¥
git push origin main
```

### 2. RenderãŒè‡ªå‹•å†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ2-3åˆ†ï¼‰

### 3. Cloudflare Pagesã‚’æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

1. https://dash.cloudflare.com/
2. Workers & Pages â†’ jaisfc
3. Create deployment â†’ Deploy now

---

## ğŸ¯ ä½¿ã„æ–¹

### è‡ªå‹•åœæ­¢ï¼ˆã‚³ãƒ¼ãƒ‰å®Ÿè£…å¾Œï¼‰

**ä½•ã‚‚ã™ã‚‹å¿…è¦ãªã—ï¼**

- R2ãŒ9GBåˆ°é” â†’ è‡ªå‹•çš„ã«æ–°è¦å¿œå‹Ÿã‚’ãƒ–ãƒ­ãƒƒã‚¯
- 8GBåˆ°é” â†’ é‹å–¶è€…ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆè­¦å‘Šï¼‰

---

### æ‰‹å‹•ç·Šæ€¥åœæ­¢

ç·Šæ€¥æ™‚ã«å³åº§ã«å¿œå‹Ÿã‚’åœæ­¢ã™ã‚‹å ´åˆ:

#### 1. Renderã§ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 

1. https://dashboard.render.com/
2. **japan-ai-backend** â†’ **Environment**
3. **Add Environment Variable**
4. è¿½åŠ :
   ```
   Key: EMERGENCY_STOP
   Value: true
   ```
5. **Save Changes**

#### 2. å†é–‹ã™ã‚‹å ´åˆ

ç’°å¢ƒå¤‰æ•° `EMERGENCY_STOP` ã‚’å‰Šé™¤ã€ã¾ãŸã¯å€¤ã‚’ `false` ã«å¤‰æ›´

---

## âœ… å‹•ä½œç¢ºèª

### 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã:
```
https://japan-ai-backend.onrender.com/api/health
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**
```json
{
  "status": "ok",
  "storageUsage": "6.5 GB / 10 GB",
  "storagePercent": "65.0%",
  "submissionsAllowed": true,
  "emergencyStopped": false
}
```

### 2. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒ90%ã®å ´åˆ

```json
{
  "status": "ok",
  "storageUsage": "9.2 GB / 10 GB",
  "storagePercent": "92.0%",
  "submissionsAllowed": false,  â† false ã«ãªã‚‹
  "emergencyStopped": false
}
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆ

1. https://jaisfc.pages.dev ã«ã‚¢ã‚¯ã‚»ã‚¹
2. å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦é€ä¿¡
3. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒ90%è¶…ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## ğŸ“Š ç›£è¦–æ–¹æ³•

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã®ç¢ºèª

**æ–¹æ³•1: APIçµŒç”±ï¼ˆæ¨å¥¨ï¼‰**
```
https://japan-ai-backend.onrender.com/api/health
```

**æ–¹æ³•2: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**
```
https://dash.cloudflare.com/ â†’ R2 â†’ japan-ai-film-competition
```

**æ–¹æ³•3: Renderãƒ­ã‚°**
```
https://dashboard.render.com/ â†’ japan-ai-backend â†’ Logs
â†’ "R2 Storage Usage: X.X GB / 10 GB" ã‚’æ¤œç´¢
```

---

## ğŸ¯ å‹•ä½œãƒ•ãƒ­ãƒ¼

```
å¿œå‹Ÿè€…ãŒãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    â†“
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: /api/submit/init
    â†“
[ãƒã‚§ãƒƒã‚¯1] ç·Šæ€¥åœæ­¢ãƒ•ãƒ©ã‚°ç¢ºèª
    â†“ NO
[ãƒã‚§ãƒƒã‚¯2] R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ç¢ºèª
    â†“ < 90%
[ãƒã‚§ãƒƒã‚¯3] ç· åˆ‡ç¢ºèª
    â†“ ç· åˆ‡å‰
å¿œå‹Ÿã‚’å—ä»˜ âœ…

---

R2ãŒ90%è¶…ã®å ´åˆ:
    â†“
å¿œå‹Ÿã‚’æ‹’å¦ âŒ
    â†“
ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º:
ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€
```

---

## ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

### 80%åˆ°é”æ™‚ï¼ˆè­¦å‘Šï¼‰

**ä»¶å:**
```
âš ï¸ R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è­¦å‘Š: 80%åˆ°é”
```

**å†…å®¹:**
```
R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒ80%ã«åˆ°é”ã—ã¾ã—ãŸã€‚

ç¾åœ¨ã®ä½¿ç”¨é‡: 8.2 GB / 10 GB (82.0%)

å¯¾ç­–:
1. å¤ã„å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
2. ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
3. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

90%åˆ°é”æ™‚ã€æ–°è¦å¿œå‹Ÿã‚’è‡ªå‹•åœæ­¢ã—ã¾ã™ã€‚
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q: å®Ÿè£…å¾Œã‚‚ãƒã‚§ãƒƒã‚¯ãŒå‹•ã‹ãªã„

**A:** Renderãƒ­ã‚°ã‚’ç¢ºèª:
```
https://dashboard.render.com/ â†’ japan-ai-backend â†’ Logs
```

`ListObjectsV2Command` ã®ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèªã€‚

---

### Q: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒ90%è¶…ãˆãŸã®ã«å¿œå‹Ÿã§ãã‚‹

**A:** ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢:
1. Ctrl + Shift + R ã§ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰
2. `/api/health` ã§ `submissionsAllowed: false` ã‚’ç¢ºèª

---

### Q: æ‰‹å‹•åœæ­¢ãŒåŠ¹ã‹ãªã„

**A:** ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª:
1. Renderã§ `EMERGENCY_STOP=true` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. ä¿å­˜å¾Œã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ï¼ˆ2-3åˆ†ï¼‰

---

## ğŸŠ ã¾ã¨ã‚

### å®Ÿè£…å¾Œã®ä¿è­·

âœ… **9GBåˆ°é”ã§è‡ªå‹•åœæ­¢**
âœ… **8GBåˆ°é”ã§è­¦å‘Šãƒ¡ãƒ¼ãƒ«**
âœ… **æ‰‹å‹•ç·Šæ€¥åœæ­¢ã‚‚å¯èƒ½**
âœ… **å®Œå…¨ç„¡æ–™é‹ç”¨ã‚’ä¿è¨¼**

### ã“ã‚Œã§å®‰å¿ƒï¼

- ç„¡æ–™æ è¶…éã®ãƒªã‚¹ã‚¯ã‚¼ãƒ­
- è‡ªå‹•ç›£è¦–ãƒ»è‡ªå‹•åœæ­¢
- é‹å–¶è€…ã¸ã®äº‹å‰é€šçŸ¥

**å®Œå…¨ç„¡æ–™é‹ç”¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ï¼** ğŸ‰

---

**ä½œæˆæ—¥:** 2025å¹´10æœˆ20æ—¥
**å®Ÿè£…æ™‚é–“:** 30åˆ†

Â© 2025 Japan AI Short Film Competition. All rights reserved.
