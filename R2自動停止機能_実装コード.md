# 🛡️ R2容量自動停止機能 - 実装コード

**目的:** R2が9GB到達で自動的に応募受付を停止

---

## 📋 実装する機能

### 1. 自動停止（9GB到達時）
- R2使用量を自動チェック
- 9GB（90%）到達で新規応募を自動ブロック
- エラーメッセージを表示

### 2. 警告通知（8GB到達時）
- 8GB（80%）到達で運営者にメール送信
- 事前に対応可能

### 3. 手動緊急停止
- 環境変数で即座に停止
- 緊急時用

---

## 🔧 実装手順

### ステップ1: server.jsに関数を追加

`server.js` の **`function isDeadlinePassed()`** の後に、以下のコードを追加:

```javascript
// Emergency stop flag (can be set via environment variable)
function isEmergencyStopped() {
  return process.env.EMERGENCY_STOP === 'true';
}

// R2 Storage monitoring
async function checkR2StorageUsage() {
  try {
    const bucketName = process.env.R2_BUCKET_NAME || 'japan-ai-film-competition';
    const command = new ListObjectsV2Command({
      Bucket: bucketName,
    });

    const response = await r2Client.send(command);
    const objects = response.Contents || [];

    // Calculate total size in bytes
    const totalBytes = objects.reduce((sum, obj) => sum + (obj.Size || 0), 0);
    const totalGB = (totalBytes / (1024 * 1024 * 1024)).toFixed(2);
    const usagePercent = (totalBytes / (10 * 1024 * 1024 * 1024)) * 100;

    console.log(`R2 Storage Usage: ${totalGB} GB / 10 GB (${usagePercent.toFixed(1)}%)`);

    // Check if storage is near limit
    if (usagePercent >= 90) {
      console.error(`🔴 CRITICAL: R2 storage at ${usagePercent.toFixed(1)}% - Blocking new submissions`);
      return { allowed: false, usage: totalGB, limit: 10, usagePercent: usagePercent.toFixed(1) };
    } else if (usagePercent >= 80) {
      console.warn(`🟡 WARNING: R2 storage at ${usagePercent.toFixed(1)}%`);
      // Send warning email (implement below)
      await sendStorageWarningEmail(totalGB, usagePercent.toFixed(1));
    }

    return { allowed: true, usage: totalGB, limit: 10, usagePercent: usagePercent.toFixed(1) };
  } catch (error) {
    console.error('Failed to check R2 storage:', error);
    // Allow submissions if check fails (fail open)
    return { allowed: true, usage: 0, limit: 10, usagePercent: 0 };
  }
}

// Send storage warning email
async function sendStorageWarningEmail(currentGB, usagePercent) {
  const mailOptions = {
    from: process.env.EMAIL_USER,
    to: process.env.EMAIL_USER,
    subject: '⚠️ R2ストレージ警告: 80%到達',
    text: `
R2ストレージ使用量が80%に到達しました。

現在の使用量: ${currentGB} GB / 10 GB (${usagePercent}%)

対策:
1. 古い動画ファイルを削除
2. 不要なファイルを削除
3. ストレージをクリーンアップ

90%到達時、新規応募を自動停止します。

管理画面: https://dash.cloudflare.com/ → R2 → japan-ai-film-competition

このメールは自動送信されています。
Japan AI Short Film Competition 運営システム
    `,
  };

  try {
    await transporter.sendMail(mailOptions);
    console.log('Storage warning email sent');
  } catch (error) {
    console.error('Failed to send warning email:', error);
  }
}
```

---

### ステップ2: `/api/submit/init` エンドポイントを修正

`server.js` の `/api/submit/init` エンドポイント（約170行目付近）を探して、**最初に**以下のチェックを追加:

```javascript
app.post('/api/submit/init',
  strictLimiter,
  [
    body('name').trim().notEmpty().isLength({ max: 100 }),
    body('email').isEmail().normalizeEmail(),
    body('filmTitle').trim().notEmpty().isLength({ max: 200 }),
    body('fileSize').isNumeric().custom(value => value <= 500 * 1024 * 1024),
    body('fileName').trim().notEmpty()
  ],
  async (req, res) => {
    // === ここから追加 ===

    // Check if emergency stopped
    if (isEmergencyStopped()) {
      return res.status(503).json({
        success: false,
        error: 'SERVICE_UNAVAILABLE',
        message: '現在、応募受付を一時停止しています。しばらくしてからもう一度お試しください。'
      });
    }

    // Check R2 storage capacity
    const storageCheck = await checkR2StorageUsage();
    if (!storageCheck.allowed) {
      return res.status(507).json({
        success: false,
        error: 'STORAGE_FULL',
        message: 'ストレージ容量が不足しています。運営にお問い合わせください。'
      });
    }

    // === ここまで追加 ===

    // Check deadline
    if (isDeadlinePassed()) {
      return res.status(400).json({
        success: false,
        error: 'DEADLINE_PASSED',
        message: 'The submission deadline has passed.'
      });
    }

    // 既存のコードを続ける...
```

---

### ステップ3: `/api/health` エンドポイントに情報追加

`/api/health` エンドポイント（約468行目付近）を以下のように更新:

```javascript
app.get('/api/health', async (req, res) => {
  const r2Configured = !!(process.env.R2_ENDPOINT && process.env.R2_ACCESS_KEY_ID && process.env.R2_SECRET_ACCESS_KEY && process.env.R2_BUCKET_NAME);

  // Check storage status
  let storageInfo = { usage: 'unknown', usagePercent: 0, allowed: true };
  if (r2Configured) {
    storageInfo = await checkR2StorageUsage();
  }

  res.json({
    status: 'ok',
    deadline: DEADLINE.toISOString(),
    deadlinePassed: isDeadlinePassed(),
    emergencyStopped: isEmergencyStopped(),
    cloudStorage: 'Cloudflare R2',
    cloudStorageStatus: r2Configured ? 'configured' : 'not configured',
    storageUsage: `${storageInfo.usage} GB / ${storageInfo.limit} GB`,
    storagePercent: `${storageInfo.usagePercent}%`,
    submissionsAllowed: !isDeadlinePassed() && !isEmergencyStopped() && storageInfo.allowed,
    maxFileSize: '500MB',
    paymentMethods: ['Stripe (Credit Card, Apple Pay, Google Pay)']
  });
});
```

---

### ステップ4: フロントエンドのエラー処理

`src/components/AIFilmCompetition.jsx` の `handleSubmit` 関数で、新しいエラーコードを処理:

約250-270行目付近の `try-catch` ブロックの `catch` 部分を確認:

```javascript
} catch (error) {
  console.error('Submission error:', error);
  setUploadStage('error');
  setIsSubmitting(false);

  // === この部分を追加/更新 ===
  if (error.response?.data?.error === 'STORAGE_FULL') {
    setErrorMessage(lang === 'ja'
      ? 'ストレージ容量が不足しているため、現在応募を受け付けることができません。運営までお問い合わせください。'
      : 'Storage capacity is full. Please contact the organizers.');
  } else if (error.response?.data?.error === 'SERVICE_UNAVAILABLE') {
    setErrorMessage(lang === 'ja'
      ? '現在、応募受付を一時停止しています。しばらくしてからもう一度お試しください。'
      : 'Submissions are temporarily unavailable. Please try again later.');
  } else if (error.response?.data?.error === 'RATE_LIMIT') {
    setErrorMessage(t.rateLimitError);
  } else {
    setErrorMessage(t.uploadError);
  }
  // === ここまで ===

  setShowError(true);
}
```

---

## 🚀 デプロイ手順

### 1. コード変更をコミット

```bash
cd C:\Users\user\Desktop\jaisfc2

# 変更を確認
git status

# コミット
git add server.js src/components/AIFilmCompetition.jsx
git commit -m "Add automatic R2 storage monitoring and emergency stop

- Block submissions when R2 storage reaches 90% (9GB)
- Send warning email at 80% (8GB)
- Add manual emergency stop via environment variable
- Update health endpoint with storage info
- Add frontend error handling for storage errors"

# プッシュ
git push origin main
```

### 2. Renderが自動再デプロイ（2-3分）

### 3. Cloudflare Pagesを手動デプロイ

1. https://dash.cloudflare.com/
2. Workers & Pages → jaisfc
3. Create deployment → Deploy now

---

## 🎯 使い方

### 自動停止（コード実装後）

**何もする必要なし！**

- R2が9GB到達 → 自動的に新規応募をブロック
- 8GB到達 → 運営者にメール送信（警告）

---

### 手動緊急停止

緊急時に即座に応募を停止する場合:

#### 1. Renderで環境変数を追加

1. https://dashboard.render.com/
2. **japan-ai-backend** → **Environment**
3. **Add Environment Variable**
4. 追加:
   ```
   Key: EMERGENCY_STOP
   Value: true
   ```
5. **Save Changes**

#### 2. 再開する場合

環境変数 `EMERGENCY_STOP` を削除、または値を `false` に変更

---

## ✅ 動作確認

### 1. ヘルスチェックで確認

ブラウザで開く:
```
https://japan-ai-backend.onrender.com/api/health
```

**期待される出力:**
```json
{
  "status": "ok",
  "storageUsage": "6.5 GB / 10 GB",
  "storagePercent": "65.0%",
  "submissionsAllowed": true,
  "emergencyStopped": false
}
```

### 2. ストレージが90%の場合

```json
{
  "status": "ok",
  "storageUsage": "9.2 GB / 10 GB",
  "storagePercent": "92.0%",
  "submissionsAllowed": false,  ← false になる
  "emergencyStopped": false
}
```

### 3. フロントエンドでテスト

1. https://jaisfc.pages.dev にアクセス
2. 応募フォームに入力して送信
3. ストレージが90%超の場合、エラーメッセージが表示される

---

## 📊 監視方法

### ストレージ使用量の確認

**方法1: API経由（推奨）**
```
https://japan-ai-backend.onrender.com/api/health
```

**方法2: ダッシュボード**
```
https://dash.cloudflare.com/ → R2 → japan-ai-film-competition
```

**方法3: Renderログ**
```
https://dashboard.render.com/ → japan-ai-backend → Logs
→ "R2 Storage Usage: X.X GB / 10 GB" を検索
```

---

## 🎯 動作フロー

```
応募者がフォーム送信
    ↓
バックエンド: /api/submit/init
    ↓
[チェック1] 緊急停止フラグ確認
    ↓ NO
[チェック2] R2ストレージ使用量確認
    ↓ < 90%
[チェック3] 締切確認
    ↓ 締切前
応募を受付 ✅

---

R2が90%超の場合:
    ↓
応募を拒否 ❌
    ↓
エラーメッセージ表示:
「ストレージ容量が不足しています」
```

---

## 📧 メール通知

### 80%到達時（警告）

**件名:**
```
⚠️ R2ストレージ警告: 80%到達
```

**内容:**
```
R2ストレージ使用量が80%に到達しました。

現在の使用量: 8.2 GB / 10 GB (82.0%)

対策:
1. 古い動画ファイルを削除
2. 不要なファイルを削除
3. ストレージをクリーンアップ

90%到達時、新規応募を自動停止します。
```

---

## 🔧 トラブルシューティング

### Q: 実装後もチェックが動かない

**A:** Renderログを確認:
```
https://dashboard.render.com/ → japan-ai-backend → Logs
```

`ListObjectsV2Command` のエラーがないか確認。

---

### Q: ストレージが90%超えたのに応募できる

**A:** ブラウザのキャッシュをクリア:
1. Ctrl + Shift + R でハードリロード
2. `/api/health` で `submissionsAllowed: false` を確認

---

### Q: 手動停止が効かない

**A:** 環境変数を確認:
1. Renderで `EMERGENCY_STOP=true` が設定されているか
2. 保存後、再デプロイが完了しているか（2-3分）

---

## 🎊 まとめ

### 実装後の保護

✅ **9GB到達で自動停止**
✅ **8GB到達で警告メール**
✅ **手動緊急停止も可能**
✅ **完全無料運用を保証**

### これで安心！

- 無料枠超過のリスクゼロ
- 自動監視・自動停止
- 運営者への事前通知

**完全無料運用が保証されます！** 🎉

---

**作成日:** 2025年10月20日
**実装時間:** 30分

© 2025 Japan AI Short Film Competition. All rights reserved.
