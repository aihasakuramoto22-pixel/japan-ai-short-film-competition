# ⚡ 本番環境移行 - 最速ガイド（15分）

**現在:** テストモード（決済されない）
**目標:** 本番モード（実際に決済される）

---

## 🎯 必須作業（3つ）

### 1. Stripe本番APIキー取得（5分）⭐⭐⭐

#### ステップ1: 本番モードに切り替え

1. https://dashboard.stripe.com/ にログイン
2. 左上の **「テストモード」トグル** をクリック → **オフ（本番モード）**

#### ステップ2: 本番APIキー取得

1. **Developers** → **API keys**
2. 以下をコピー:
   - **Publishable key**: `pk_live_...` で始まる
   - **Secret key**: `sk_live_...` で始まる（「Reveal live key token」をクリック）

**保存してください：**
```
STRIPE_PUBLISHABLE_KEY (公開鍵): pk_live_...
STRIPE_SECRET_KEY (シークレット): sk_live_...
```

---

### 2. 環境変数を本番用に更新（5分）⭐⭐⭐

#### A. Cloudflare Pages（フロントエンド）

1. https://dash.cloudflare.com/ にアクセス
2. **Workers & Pages** → **jaisfc** プロジェクト
3. **Settings** → **Environment variables**
4. **「Edit variables」** をクリック
5. `VITE_STRIPE_PUBLISHABLE_KEY` を更新:

```
変更前: pk_test_51SJQj3Jwsbd7SooaAA345...
変更後: pk_live_... （ステップ1で取得した本番公開鍵）
```

6. **「Save」** をクリック
7. **Deployments** → 最新デプロイの **「⋯」** → **「Retry deployment」**
8. 3分待つ

---

#### B. Render（バックエンド）

1. https://dashboard.render.com/ にアクセス
2. **japan-ai-backend** サービスをクリック
3. **Environment** タブ
4. `STRIPE_SECRET_KEY` を探して **「Edit」**
5. 値を更新:

```
変更前: sk_test_YOUR_STRIPE_SECRET_KEY
変更後: sk_live_... （ステップ1で取得した本番シークレット）
```

6. **「Save Changes」** をクリック
7. 自動で再デプロイ（2-3分）

---

### 3. UptimeRobotでスリープ対策（5分）⭐⭐⭐

Renderがスリープしないように5分ごとに監視:

#### 手順

1. https://uptimerobot.com/ にアクセス
2. **「Sign Up」** → 無料アカウント作成
3. メール確認
4. **「+ Add New Monitor」** をクリック
5. 以下を入力:

```
Monitor Type: HTTP(s)
Friendly Name: JAISFC Backend
URL (or IP): https://japan-ai-backend.onrender.com/api/health
Monitoring Interval: 5 minutes
```

6. **「Create Monitor」** をクリック
7. Status が **「Up」** になることを確認 ✅

---

## ✅ 完了確認（3分）

### ステップ1: バックエンド確認

ブラウザで開く:
```
https://japan-ai-backend.onrender.com/api/health
```

**期待される出力:**
```json
{
  "status": "ok",
  "cloudStorage": "Cloudflare R2",
  "cloudStorageStatus": "configured"
}
```

---

### ステップ2: フロントエンド確認

ブラウザで開く:
```
https://jaisfc.pages.dev
```

**確認項目:**
- ✅ サイトが表示される
- ✅ HTTPS（鍵アイコン）
- ✅ フォームが正常に表示される

---

### ステップ3: 本番決済テスト

⚠️ **注意:** 本番モードなので**実際に決済されます**

#### テストカードを使う（決済されない）

```
カード番号: 4242 4242 4242 4242
有効期限: 任意の未来の日付（例: 12/28）
CVC: 任意の3桁（例: 123）
郵便番号: 任意
```

#### 手順

1. `https://jaisfc.pages.dev` にアクセス
2. 応募フォームに入力:
   ```
   氏名: テスト太郎
   メール: your_real_email@gmail.com （実際のメールアドレス）
   電話: 090-1234-5678
   作品タイトル: テスト作品
   カテゴリ: 任意
   ポスター: 小さい画像（< 5MB）
   動画: 小さい動画（< 500MB）
   ```
3. **「支払いに進む」** をクリック
4. Stripeテストカード番号を入力
5. 決済完了
6. 成功ページが表示される ✅
7. メールが届く（2通）✅

---

## 🎊 本番環境完成！

### これで完了です

✅ Stripeが本番モード（実際に決済される）
✅ フロントエンド本番稼働（https://jaisfc.pages.dev）
✅ バックエンド本番稼働（https://japan-ai-backend.onrender.com）
✅ スリープ対策完了（UptimeRobot）
✅ 動画アップロード可能（Cloudflare R2）
✅ メール通知機能

**総コスト: 0円/月**（Stripe手数料3.6%のみ）

---

## 📋 本番環境URL一覧

| 項目 | URL |
|------|-----|
| **メインサイト** | https://jaisfc.pages.dev |
| **バックエンドAPI** | https://japan-ai-backend.onrender.com/api |
| **ヘルスチェック** | https://japan-ai-backend.onrender.com/api/health |
| **Stripe管理** | https://dashboard.stripe.com/ |
| **Cloudflare管理** | https://dash.cloudflare.com/ |
| **Render管理** | https://dashboard.render.com/ |
| **UptimeRobot管理** | https://uptimerobot.com/dashboard |

---

## ⚠️ 重要な注意事項

### 本番モードでは実際に決済される

- テストする場合は必ず **Stripeテストカード** を使用
- 実際のクレジットカードは使用しない（決済されます）
- 返金する場合はStripeダッシュボードから手動で行う

### Stripeテストカード（本番モードでも使用可能）

```
成功: 4242 4242 4242 4242
失敗: 4000 0000 0000 0002
認証必須: 4000 0025 0000 3155
```

---

## 🔒 セキュリティチェック

### 本番環境で確認すべき項目

- [ ] GitHubリポジトリに `.env` ファイルがコミットされていない
- [ ] Stripe Secret Keyが公開されていない
- [ ] R2 Secret Access Keyが公開されていない
- [ ] Gmail アプリパスワードが公開されていない
- [ ] すべての機密情報がCloudflare/Renderの環境変数に設定されている

**確認方法:**
```bash
cd C:\Users\user\Desktop\jaisfc2
git log --all --full-history -- .env
```

何も表示されなければOK ✅

---

## 📞 本番運用開始後の対応

### 応募があった場合

1. **メールで通知が届く:**
   - 宛先: `japanaishortfilmcompetition@gmail.com`
   - 件名: 「【新規応募】Japan AI Short Film Competition」

2. **Stripe決済を確認:**
   - https://dashboard.stripe.com/ → Payments
   - 決済金額、日時、顧客情報を確認

3. **動画を確認:**
   - https://dash.cloudflare.com/ → R2
   - バケット `japan-ai-film-competition`
   - アップロードされた動画ファイルを確認

---

## 🎯 次のステップ（オプション）

### A. 独自ドメイン設定

無料ドメイン: `https://jaisfc.pages.dev`
→ 独自ドメイン: `https://jaisfc.com`（有料）

詳細: `CLOUDFLARE_DNS_SETUP.md` 参照

---

### B. アクセス解析

Cloudflare Pagesダッシュボードで:
- 訪問者数
- ページビュー
- 地域別アクセス

確認可能。

---

### C. 応募締切の変更

現在: **2025年11月30日 23:59**

変更方法: `完全運用ガイド.md` の「応募締切管理」セクション参照

---

## ✅ 最終チェックリスト

### 本番環境稼働確認

- [ ] Stripeが本番モード（`pk_live_...`, `sk_live_...`）
- [ ] Cloudflare Pagesに本番APIキーが設定されている
- [ ] Renderに本番APIキーが設定されている
- [ ] UptimeRobotで監視設定済み
- [ ] バックエンドAPIが応答する（`/api/health`）
- [ ] フロントエンドが表示される（`https://jaisfc.pages.dev`）
- [ ] テスト決済が成功する
- [ ] メールが届く（2通）
- [ ] 動画がR2にアップロードされる

**すべてチェックできたら完了！** 🎉

---

## 🎊 おめでとうございます！

**本番環境が完成しました！**

これで実際に応募を受け付けられます。

**サイトURL:**
```
https://jaisfc.pages.dev
```

このURLを公開して、応募者を募集できます！

---

**作成日:** 2025年10月20日
**所要時間:** 15分
**対象:** 本番環境移行作業

© 2025 Japan AI Short Film Competition. All rights reserved.
